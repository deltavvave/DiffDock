# Stage 1: Build Environment Setup
FROM nvidia/cuda:11.7.1-devel-ubuntu22.04 as builder

RUN apt-get update -y && apt-get install -y wget curl git tar bzip2 unzip && rm -rf /var/lib/apt/lists/*

# Create a user
ENV APPUSER="appuser"
ENV HOME=/home/$APPUSER
RUN useradd -m -u 1000 $APPUSER
USER $APPUSER
WORKDIR $HOME

ENV ENV_NAME="diffdock"
ENV DIR_NAME="DiffDock"

# Install micromamba
RUN curl -Ls https://micro.mamba.pm/api/micromamba/linux-64/latest | tar -xj bin/micromamba
ENV PATH=$HOME/bin:$HOME/.local/bin:$PATH

# Create a basic environment with packaging installed
RUN ~/bin/micromamba create -n base_env python=3.9 pip && \
    ~/bin/micromamba run -n base_env pip install packaging && \
    ~/bin/micromamba env export -n base_env --file base_env.yml && \
    rm -rf ~/micromamba/envs/base_env

# Copy the environment file and create the Conda environment
COPY --chown=$APPUSER:$APPUSER ./environment.yml environment.yml
COPY --chown=$APPUSER:$APPUSER ./requirements.txt .

# Install the packaging module first
RUN ~/bin/micromamba env update --name base --file base_env.yml && \
    ~/bin/micromamba env create --file environment.yml && \
    ~/bin/micromamba run -n ${ENV_NAME} pip install packaging

# Install other pip packages
RUN ~/bin/micromamba run -n ${ENV_NAME} pip install -r requirements.txt

# Clean up micromamba cache
RUN ~/bin/micromamba clean -afy --quiet

# Copy application code
COPY --chown=$APPUSER:$APPUSER . $HOME/$DIR_NAME

# Stage 2: Runtime Environment
FROM nvidia/cuda:11.7.1-runtime-ubuntu22.04

# Create user and setup environment
ENV APPUSER="appuser"
ENV HOME=/home/$APPUSER
RUN useradd -m -u 1000 $APPUSER
USER $APPUSER
WORKDIR $HOME

ENV ENV_NAME="diffdock"
ENV DIR_NAME="DiffDock"

# Copy the Conda environment and application code from the builder stage
COPY --from=builder --chown=$APPUSER:$APPUSER $HOME/micromamba $HOME/micromamba
COPY --from=builder --chown=$APPUSER:$APPUSER $HOME/bin $HOME/bin
COPY --from=builder --chown=$APPUSER:$APPUSER $HOME/$DIR_NAME $HOME/$DIR_NAME
WORKDIR $HOME/$DIR_NAME

# Set the environment variables
ENV MAMBA_ROOT_PREFIX=$HOME/micromamba
ENV PATH=$HOME/bin:$HOME/.local/bin:$PATH
RUN micromamba shell init -s bash --root-prefix $MAMBA_ROOT_PREFIX

# Precompute series for SO(2) and SO(3) groups
RUN micromamba run -n ${ENV_NAME} python utils/precompute_series.py

# Expose port for FastAPI
EXPOSE 8000

# Default command to run the FastAPI application
CMD ["sh", "-c", "micromamba run -n ${ENV_NAME} uvicorn diffdock_api:app --host 0.0.0.0 --port 8000"]
